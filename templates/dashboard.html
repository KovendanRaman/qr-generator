<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Dashboard - QR Generator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    {% include 'components/header.html' %}

    <main>
        <div class="content-card">
            <h1>Welcome to your Dashboard</h1>
            <p>Logged in as: <strong>{{ user.email }}</strong></p>

            <hr>

            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="flash-message flash-{{ category }}">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <div class="history-header">
                <h2>Your Saved History</h2>
                <div class="sort-container">
                    <label for="sort-select" class="sort-label">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M3 6h18M7 12h10M11 18h2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        Sort by:
                    </label>
                    <select id="sort-select" class="sort-select" onchange="window.location.href='/history?sort=' + this.value">
                        <option value="date_desc" {% if current_sort == 'date_desc' %}selected{% endif %}>Newest First</option>
                        <option value="date_asc" {% if current_sort == 'date_asc' %}selected{% endif %}>Oldest First</option>
                        <option value="title_asc" {% if current_sort == 'title_asc' %}selected{% endif %}>A → Z</option>
                        <option value="title_desc" {% if current_sort == 'title_desc' %}selected{% endif %}>Z → A</option>
                    </select>
                </div>
            </div>

            <div id="history-container">
                <div id="history-loading" class="history-loading">
                    <span class="history-loading-text">Loading your QR codes…</span>
                </div>
            </div>
            <p id="history-empty" class="history-empty" style="display: none;">You haven't generated any QR codes yet. <a href="/">Try one now!</a></p>
        </div>
    </main>
    {% include 'components/footer.html' %}

    <script>
    (function() {
        var currentSort = "{{ current_sort }}";
        var container = document.getElementById('history-container');
        var loadingEl = document.getElementById('history-loading');
        var emptyEl = document.getElementById('history-empty');

        function escapeHtml(s) {
            if (s == null) return '';
            var d = document.createElement('div');
            d.textContent = s;
            return d.innerHTML;
        }

        function renderHistory(history) {
            if (!history || history.length === 0) {
                loadingEl.style.display = 'none';
                emptyEl.style.display = 'block';
                return;
            }
            var grid = document.createElement('div');
            grid.className = 'history-grid';
            var svgEdit = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
            var svgQR = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px;"><rect x="3" y="3" width="7" height="7" fill="currentColor"/><rect x="14" y="3" width="7" height="7" fill="currentColor"/><rect x="3" y="14" width="7" height="7" fill="currentColor"/><rect x="14" y="14" width="7" height="7" fill="currentColor"/></svg>';
            history.forEach(function(item, index) {
                var title = item.title || item.url || '';
                var url = item.url || '#';
                var dateStr = item.created_at ? item.created_at.slice(0, 10) : 'Unknown';
                var centerText = (item.center_text || '').replace(/"/g, '&quot;');
                var style = item.style || 'square';
                var id = item.id;
                var idx = index + 1;
                grid.innerHTML +=
                    '<div class="history-item">' +
                    '<div class="title-container">' +
                    '<h3 id="title-' + id + '" class="qr-title" data-qr-id="' + escapeHtml(String(id)) + '" data-title="' + escapeHtml(title) + '">' + escapeHtml(title) + '</h3>' +
                    '<button onclick="editTitleClick(' + id + ')" class="edit-title-btn" title="Edit title">' + svgEdit + '</button>' +
                    '</div>' +
                    '<div class="history-url"><a href="' + escapeHtml(url) + '" target="_blank" class="history-link" title="' + escapeHtml(url) + '">' + escapeHtml(url) + '</a></div>' +
                    '<div id="qr-container-' + idx + '" class="qr-code-container" data-url="' + escapeHtml(url) + '" data-center-text="' + escapeHtml(item.center_text || '') + '" data-style="' + escapeHtml(style) + '">' +
                    '<button onclick="loadQRClick(' + idx + ')" class="view-qr-btn">' + svgQR + 'View QR Code</button>' +
                    '</div>' +
                    '<small class="history-date">Saved: ' + escapeHtml(dateStr) + '</small>' +
                    '</div>';
            });
            loadingEl.style.display = 'none';
            emptyEl.style.display = 'none';
            container.innerHTML = '';
            container.appendChild(grid);
        }

        fetch('/api/history?sort=' + encodeURIComponent(currentSort))
            .then(function(r) {
                if (r.status === 401) {
                    window.location.href = '/login';
                    return;
                }
                return r.json();
            })
            .then(function(data) {
                if (!data) return;
                if (data.error && data.error === 'session_expired') {
                    window.location.href = '/login';
                    return;
                }
                renderHistory(data.history || []);
            })
            .catch(function() {
                loadingEl.innerHTML = '<span class="history-loading-text">Could not load history. <a href="/history">Try again</a></span>';
            });
    })();

    function loadQRClick(index) {
        const containerId = 'qr-container-' + index;
        const container = document.getElementById(containerId);
        const url = container.getAttribute('data-url');
        const centerText = container.getAttribute('data-center-text') || '';
        const style = container.getAttribute('data-style') || 'square';
        
        // Create the image URL with design parameters
        const params = new URLSearchParams({
            url: url,
            center_text: centerText,
            style: style
        });
        const imageUrl = '/qrcode_image?' + params.toString();
        
        // Replace the button with the image and a download link
        container.innerHTML = `
            <div class="qr-loaded">
                <img src="${imageUrl}" alt="QR Code" class="qr-code-image">
                <a href="${imageUrl}" download="qr-code.png" class="download-link">
                    <button class="download-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 6px;">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Download
                    </button>
                </a>
            </div>
        `;
    }

    function editTitleClick(id) {
        const titleElement = document.getElementById('title-' + id);
        const currentTitle = titleElement.getAttribute('data-title');
        const newTitle = prompt('Edit title:', currentTitle);
        
        if (newTitle && newTitle !== currentTitle) {
            // Send update request to server
            fetch('/update_title', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    id: id,
                    title: newTitle
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    titleElement.textContent = data.title;
                    titleElement.setAttribute('data-title', data.title);
                } else {
                    alert('Failed to update title: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to update title');
            });
        }
    }
    </script>

    <style>
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .qr-loaded {
        display: flex;
        flex-direction: column;
        align-items: center;
        animation: fadeIn 0.4s ease-out;
    }
    </style>
</body>
</html>